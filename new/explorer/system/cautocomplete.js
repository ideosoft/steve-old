"use strict";function CAutocomplete(parent,parameters){var self=this;this.attributes={wrapper:{className:"cautocomplete-box"},row:{className:"row",onmouseover:function(){self.SetActive(this)},onclick:function(){self.Abort(),self.trigger("onEnter",{text:self.GetValue(),type:self.GetType()}),self.Clear()},ico:{className:"ico"},hint:{className:"hint"},text:{className:"text"}}},CBase.call(this,parent||null,parameters),this.name="CAutocomplete",this.active=null,this.events={},this.isVisible=!1,CAutocomplete.parameters.forEach(function(name){void 0!==parameters[name]&&(self[name]=parameters[name])}),this.bind(this.events),this.base=this.base||this.input,this.size=this.size||0,this.Init(element("div",this.attributes.wrapper)),this.buffer={},this.input.oninput=function(oninput){return function(event){self.Show(!1,!1),clearTimeout(self.input_timer),self.input.value!==self.GetDefault()&&(self.buffer.data=self.input.value,self.input_timer=setTimeout(function(){self.RefreshData(self.input.value,function(){this.Show(!0,!1),this.RefreshUi()})},600)),"function"==typeof oninput&&oninput(event)}}(this.input.oninput)}CAutocomplete.parameters=["input","base","size","data","url","events","titleField","valueField","typeField","hintField"],CAutocomplete.prototype=Object.create(CBase.prototype),CAutocomplete.prototype.constructor=CAutocomplete,CAutocomplete.prototype.onInit=function(){elchild(document.body,this.handle)},CAutocomplete.prototype.UpdateGeometry=function(){var inputRect=this.base.getBoundingClientRect();this.handle.style.top=inputRect.top+inputRect.height+"px",this.handle.style.left=inputRect.left+"px",this.handle.style.width=inputRect.width+"px"},CAutocomplete.prototype.RefreshUi=function(data){var i,size,row;if(""===this.handle.style.width&&this.UpdateGeometry(),data=data||this._data,elclear(this.handle),size=this.size>data.length?data.length:this.size,size>0){for(i=0;size>i;i++)row=this.AddRow(data[i]);this.SetActive(this.buffer.nextSibling=this.handle.firstElementChild),this.buffer.previousSibling=this.handle.lastElementChild}else this.Show(!1)},CAutocomplete.prototype.RefreshData=function(data,callback){var url,self=this;return""===data?void this.Show(!1,!1):(this.buffer.data=data,url=this.url?this.url+data:data,void(url&&(this.xhr=ajax("GET",url,function(res,status){200===status?("function"==typeof self.data?self._data=self.data.call(this,res):self._data=res[self.data],callback.call(self,res),self.trigger("onDataLoad",data)):self.Show(!1)}))))},CAutocomplete.prototype.GetTitle=function(data){return data=data||this.active.data,this.active===this.buffer?data:this.titleField?data[this.titleField]:this.active.data},CAutocomplete.prototype.GetValue=function(data){return data=data||this.active.data,this.active===this.buffer?data:(data=this.valueField?data[this.valueField]:this.GetTitle(),data=data.replace(/<\/?b>/g,""))},CAutocomplete.prototype.GetType=function(data){return data=data||this.active.data,data[this.typeField]?data[this.typeField]:"search"},CAutocomplete.prototype.GetHint=function(data){return data=data||this.active.data,this.hintField?data[this.hintField]:""},CAutocomplete.prototype.GetDefault=function(){return this.buffer.data},CAutocomplete.prototype.SetActive=function(active){null!==this.active&&this.active!==this.buffer&&this.active.classList.remove("active"),active!==this.buffer&&active.classList.add("active"),this.active=active,this.trigger("onChange")},CAutocomplete.prototype.Next=function(){this.active.nextSibling?this.SetActive(this.active.nextSibling):this.SetActive(this.buffer)},CAutocomplete.prototype.Previous=function(){this.active.previousSibling?this.SetActive(this.active.previousSibling):this.SetActive(this.buffer)},CAutocomplete.prototype.AddRow=function(data){var el,ico,hint,text,attributes=extend({},this.attributes.row);return attributes.className+=" "+this.GetType(data),ico=element("div",this.attributes.row.ico),hint=element("div",this.attributes.row.hint),text=element("div",this.attributes.row.text),elchild(this.handle,el=element("div",attributes,[ico,text,hint])),text.innerHTML=this.GetTitle(data),hint.innerHTML=this.GetHint(data),el.data=data,el},CAutocomplete.prototype.Abort=function(){void 0!==this.xhr&&this.xhr.abort()},CAutocomplete.prototype.Clear=function(){this.Show(!1),elclear(this.handle),clearTimeout(this.input_timer),this.Abort(),this.active=null,this.buffer={}},CAutocomplete.prototype.EventHandler=function(event){if(eventPrepare(event),this.isVisible===!0){switch(event.code){case KEYS.UP:this.Previous(),event.preventDefault();break;case KEYS.DOWN:this.Next(),event.preventDefault();break;case KEYS.OK:this.Abort(),this.trigger("onEnter",{text:this.GetValue(),type:this.GetType()}),this.Clear();break;default:return!1}return!0}},Events.inject(CAutocomplete);